<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Interactive 3D Surface Plot</title>
  <!-- Plotly and math.js from CDN -->
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, 'Segoe UI', sans-serif; margin: 16px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-width: 1000px; }
    label { display:block; font-size: 13px; margin-bottom:4px; }
    input, select, button, textarea { width:100%; padding:8px; box-sizing:border-box; }
    #plot { width:100%; height:640px; margin-top:12px; }
    .row { display:flex; gap:8px; }
    .col { flex:1; }
    small { color:#555; }
  </style>
</head>
<body>
  <h2>Interactive 3D Surface Plot (single-file)</h2>
  <p>Enter a function <code>f(x,y)</code> using normal math.js syntax (e.g. <code>sin(sqrt(x^2+y^2))</code>, <code>exp(-x^2-y^2)</code>, or <code>sin(x)*cos(y)</code>), then click <em>Plot</em>.</p>

  <div class="controls">
    <div>
      <label>Function (in x and y):</label>
      <input id="fn" value="sin(sqrt(x^2 + y^2)) / (sqrt(x^2 + y^2) + 1e-6)" />
      <small>Use <code>^</code> for power, <code>sin</code>, <code>cos</code>, <code>exp</code>, <code>sqrt</code>, etc. See math.js documentation for available functions.</small>
    </div>

    <div>
      <label>Color scale:</label>
      <select id="colorscale">
        <option>Viridis</option>
        <option>Portland</option>
        <option>Jet</option>
        <option selected>RdBu</option>
        <option>YlGnBu</option>
      </select>
      <label style="margin-top:8px">Show contour lines:</label>
      <select id="contours">
        <option value="true">Yes</option>
        <option value="false" selected>No</option>
      </select>
    </div>

    <div>
      <label>Laun maka 1 (min,max):</label>
      <input id="xrange" value="0,2000" />
      <label style="margin-top:8px">Laun maka 2 (min,max):</label>
      <input id="yrange" value="0,2000" />
    </div>

    <div>
      <label>Resolution (points per axis):</label>
      <input id="npts" value="80" />
      <label style="margin-top:8px">Mánuði eða ári:</label>
      <select id = 'zscale'>
        <option>Skattleghagræðing yfir árið</option>
        <option>Skattleghagræðing á mánuði </option> 
      </select>
    </div>

  </div>

  <div style="margin-top:10px; display:flex; gap:8px; max-width:1000px;">
    <button id="plotBtn">Plot</button>
    <button id="downloadPng">Hlaða niður mynd</button>
  </div>

  <div id="plot"></div>

  <script>
    // Helper: parse comma separated pair
    function parsePair(s, fallback){
      try{
        const parts = s.split(',').map(t=>parseFloat(t.trim()));
        if(parts.length===2 && parts.every(Number.isFinite)) return parts;
      }catch(e){}
      return fallback;
    }

    function buildGrid(xmin,xmax,ymin,ymax,n){
      const xs = []; const ys = [];
      for(let i=0;i<n;i++) xs.push(xmin + (xmax - xmin) * i / (n-1));
      for(let j=0;j<n;j++) ys.push(ymin + (ymax - ymin) * j / (n-1));
      return {xs, ys};
    }

    function computeZ(xs, ys, compiled, zscale){
      const Z = [];
      for(let j=0;j<ys.length;j++){
        const row = [];
        for(let i=0;i<xs.length;i++){
          const x = xs[i]; const y = ys[j];
          let z = NaN;
          try{
            // math.js compiled function expects object {x:..., y:...}
            z = compiled.evaluate({x, y});
            if(!isFinite(z)) z = NaN;
          }catch(e){ z = NaN; }
          row.push(z * zscale);
        }
        Z.push(row);
      }
      return Z;
    }

    function fn(x,y){}

    function plotSurface(fnString){
      const xrange = parsePair(document.getElementById('xrange').value, [-8,8]);
      const yrange = parsePair(document.getElementById('yrange').value, [-8,8]);
      const n = Math.max(10, Math.min(250, parseInt(document.getElementById('npts').value)||80));
      const zscale = parseFloat(document.getElementById('zscale').value) || 1;
      const colorscale = document.getElementById('colorscale').value;
      const showContours = document.getElementById('contours').value === 'true';

      let compiled;
      try{
        // compile the expression using math.js: allow 'x' and 'y'
        compiled = math.compile(fnString);
      }catch(e){
        alert('Failed to parse function. Check syntax. Error: ' + e);
        return;
      }

      const {xs, ys} = buildGrid(xrange[0], xrange[1], yrange[0], yrange[1], n);
      // compute Z
      // This may take a bit for large n; adjust n if it's slow.
      const Z = computeZ(xs, ys, compiled, zscale);

      const data = [{
        type: 'surface',
        x: xs,
        y: ys,
        z: Z,
        colorscale: colorscale,
        contours: showContours ? { z: { show:true, usecolormap: true, width:2, project:{ z:true } } } : {},
        showscale: true
      }];

      const layout = {
        title: 'z = ' + fnString,
        autosize: true,
        scene: {
          xaxis: {title:'x'},
          yaxis: {title:'y'},
          zaxis: {title:'z'}
        },
        margin: {l:0, r:0, b:0, t:40}
      };

      Plotly.newPlot('plot', data, layout, {responsive:true});
    }

    document.getElementById('plotBtn').addEventListener('click', ()=>{
      plotSurface(document.getElementById('fn').value);
    });

    document.getElementById('downloadPng').addEventListener('click', ()=>{
      Plotly.toImage('plot', {format:'png', height:800, width:1200}).then(function(url){
        const a = document.createElement('a');
        a.href = url; a.download = 'surface.png';
        document.body.appendChild(a); a.click(); a.remove();
      });
    });

    // initial render
    plotSurface(document.getElementById('fn').value);
  </script>
</body>
</html>
